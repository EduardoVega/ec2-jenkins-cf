{
"AWSTemplateFormatVersion": "2010-09-09",
    "Description": "EC2 Instance and Jenkins",
    "Metadata": {

    },
    "Parameters": {
        "InstanceType":{
            "Type": "String",
            "Default": "t2.small",
            "Description": "Instance Type"
        },
        "AMI":{
            "Type": "AWS::EC2::Image::Id",
            "Default": "ami-0c6b1d09930fac512",
            "Description": "AMI Id"
        },
        "AccessKey":{
            "Type": "AWS::EC2::KeyPair::KeyName",
            "Description": "Access Key Name"
        },
        "VPC": {
            "Type": "AWS::EC2::VPC::Id",
            "Description": "VPC Id"
        },
        "Subnet" : {
            "Type" : "AWS::EC2::Subnet::Id",
            "Description" : "Subnet Id"
        }
        
    },
    "Mappings": {

    },
    "Conditions": {

    },
    "Resources": {
        "mySecurityGroup" : {
            "Type" : "AWS::EC2::SecurityGroup",
            "Properties" : {
                "GroupDescription" : "Jenkins SG",
                "SecurityGroupIngress" : [ 
                    {
                        "IpProtocol" : "tcp",
                        "FromPort" : 8080,
                        "ToPort" : 8080,
                        "CidrIp" : "0.0.0.0/0"
                    },
                    {
                        "IpProtocol" : "tcp",
                        "FromPort" : 22,
                        "ToPort" : 22,
                        "CidrIp" : "0.0.0.0/0"
                    }
                ],
                "VpcId" : { "Ref": "VPC" }
            }
        },
        "myEC2Instance": {
            "Type": "AWS::EC2::Instance",
            "Properties": {
                "KeyName": { "Ref": "AccessKey" },
                "ImageId": { "Ref": "AMI" },
                "InstanceType": { "Ref": "InstanceType" },
                "SecurityGroupIds" : [
                    { "Ref": "mySecurityGroup" }
                ],
                "SubnetId" : { "Ref": "Subnet" },
                "UserData": {
                    "Fn::Base64": {
                        "Fn::Join": [
                            "",
                            [
                                "#!/bin/bash -xe\n",
                                "exec > >(tee /var/log/user-data.log) 2>&1\n",
                                "sudo su\n",
                                "yum -y update\n",
                                "yum -y install java-1.8.0-openjdk-devel\n",
                                "curl --silent --location http://pkg.jenkins-ci.org/redhat-stable/jenkins.repo | sudo tee /etc/yum.repos.d/jenkins.repo\n",
                                "rpm --import https://jenkins-ci.org/redhat/jenkins-ci.org.key\n",
                                "yum -y install jenkins\n",
                                "wget -O /var/lib/jenkins.tar.gz https://github.com/EduardoVega/ec2-jenkins-cf/raw/master/jenkins.tar.gz\n",
                                "tar -xvzf /var/lib/jenkins.tar.gz -C /var/lib/\n",
                                "AWSHOSTNAME=$(curl http://169.254.169.254/latest/meta-data/public-hostname)\n",
                                "sed -i \"s/<jenkinsUrl.*/<jenkinsUrl>http:\\/\\/${AWSHOSTNAME}:8080\\/<\\/jenkinsUrl>/g\" /var/lib/jenkins/jenkins.model.JenkinsLocationConfiguration.xml\n",
                                "systemctl start jenkins\n",
                                "systemctl enable jenkins\n"
                            ]
                        ]
                    }
                }
            }
        }
    },
    "Outputs": {

    }
}